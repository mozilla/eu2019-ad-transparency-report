<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 DRAFT//EN"><html lang="en"><head><title>Methods &mdash; EU Ad Transparency Report</title><meta charset="utf-8"><meta name="author" content="Jason Chuang"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,700|Fira+Mono:400,700|Zilla+Slab:600,700" rel="stylesheet"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous"><script src="../../lib/d3.min.js"></script><script src="bundle.js"></script></head><body><h1>Methods &mdash; EU Ad Transparency Report</h1><div class="intro"><div class="p">This page describes our methods to <b>track political advertising and produce an <a href="../">ad transparency report</a> for the 2019 European Parliament Election</b>.</div><div class="p">We attempted to download a copy of the political ads on a daily basis using the Facebook Ad Library API and the Google Ad Library, starting on March 29 and May 11 respectively, when the two companies released their political ads archive.</div></div><div class="section facebook" id="facebook"><h3>Facebook Ad Library API</h3><div class="content facebook"><div class="p">Facebook provides an Application Programmable Interface ("API") to authorized users who may search for ads in their archive. However, due to the inconsistent state of the Facebook Ad Library API, our methods to scan and discover ads must be adapted on a daily and sometimes hourly basis. We regret we do not have reliable or predictable instructions on how to retrieve political ads from Facebook. Below, we describe our default crawler settings and various workarounds. For more details, see our <a href="../log/">data collection log</a>.</div><h5>Identity Confirmation</h5><div class="p">To gain access to the API, you need to first <a href="http://facebook.com/id">confirm your identity with Facebook</a>. The process took approximately 11 days for us, from submitting the request online to receiving the confirmation code in the mail.</div><h5>API Parameters</h5><div class="p">According to the <a href="https://developers.facebook.com/docs/marketing-api/reference/ads_archive/v3.2">Ad Library API documentation</a>, the following parameters are available in a search query: <span class="quote">ad_active_status</span>, <span class="quote">ad_reached_countries</span>, <span class="quote">ad_type</span>, <span class="quote">search_page_ids</span>, and <span class="quote">search_terms</span>.</div><div class="p">By default, the API returns only 25 ads per page. You may request more ads per page by adding an undocumented parameter, <span class="quote">limit</span>, to either your initial search query or requests for subsequent pages.</div><div class="p">For each search, you also may request various additional data fields. Available data fields are documented on the <a href="https://developers.facebook.com/docs/marketing-api/reference/archived-ad/v3.2">Archived Ad</a> page.</div><h5>Default Crawler Settings</h5><div class="p">Our default daily crawl consists of the following search where <span class="quote">[TOKEN]</span> is the application token that you'll receive after identity confirmation.</div><div class="p"><span class="verbatim">https://graph.facebook.com/v3.2/ads_archive?access_token=[TOKEN]&ad_type=POLITICAL_AND_ISSUE_ADS&ad_active_status=ALL&fields=ad_creation_time%2Cad_creative_body%2Cad_creative_link_caption%2Cad_creative_link_description%2Cad_creative_link_title%2Cad_delivery_start_time%2Cad_delivery_stop_time%2Cad_snapshot_url%2Ccurrency%2Cfunding_entity%2Cimpressions%2Cpage_id%2Cpage_name%2Cspend%2Cregion_distribution%2Cdemographic_distribution&limit=500&ad_reached_countries=AT%2CBE%2CBG%2CHR%2CCY%2CCZ%2CDK%2CEE%2CFI%2CFR%2CDE%2CGR%2CHU%2CIE%2CIT%2CLV%2CLT%2CLU%2CMT%2CNL%2CPL%2CPT%2CRO%2CSK%2CSI%2CES%2CSE%2CGB&search_terms=.</span></div><div class="p">For readability, below is the unescaped URL:</div><div class="p"><span class="verbatim">https://graph.facebook.com/v3.2/ads_archive?access_token=[TOKEN]&ad_type=POLITICAL_AND_ISSUE_ADS&ad_active_status=ALL&fields=ad_creation_time,ad_creative_body,ad_creative_link_caption,ad_creative_link_description,ad_creative_link_title,ad_delivery_start_time,ad_delivery_stop_time,ad_snapshot_url,currency,funding_entity,impressions,page_id,page_name,spend,region_distribution,demographic_distribution&limit=500&ad_reached_countries=AT,BE,BG,HR,CY,CZ,DK,EE,FI,FR,DE,GR,HU,IE,IT,LV,LT,LU,MT,NL,PL,PT,RO,SK,SI,ES,SE,GB&search_terms=.</span></div><h5>Parameter &mdash; <span class="quote">ad_active_status<span></span></span></h5><div class="p">We always set <span class="quote">ad_active_status=ALL</span> to request all ads in the archive.</div><h5>Parameter &mdash; <span class="quote">ad_reached_countries</span></h5><div class="p">By default, we search for ads in the all 28 member states by setting <span class="quote">ad_reached_countries</span> to <span class="quote">AT,BE,BG,HR,CY,CZ,DK,EE,FI,FR,DE,GR,HU,IE,IT,LV,LT,LU,MT,NL,PL,PT,RO,SK,SI,ES,SE,GB</span>.</div><h6>Facebook uses ISO instead of EU-recommended country codes</h6><div class="pp">Facebook uses ISO-3166 country code instead of the EU-recommended country code. The United Kingdom is coded as <span class="quote">GB</span> instead of <span class="quote">UK</span>. Greece is coded as <span class="quote">GR</span> instead of <span class="quote">EL</span>.</div><h6>Workaround for pagination errors</h6><div class="pp">We frequently encounter pagination issues (e.g., <a href="../log/#fb-infinite-loop-bug">infinite loop bug</a>, <a href="../log/#fb-invalid-next-page-bug">invalid next page bug</a>, <a href="../log/#fb-random-termination-bug">random termination bug</a>) and are unable to retrieve all pages associated with a search. When such errors occur, we split the crawl into 28 smaller searches, by requesting the ads for each member state separately (e.g., <span class="quote">ad_reached_countries=AT</span>, <span class="quote">ad_reached_countries=BE</span>, <span class="quote">ad_reached_countries=BG</span>).</div><div class="pp">However, please be aware that the <a href="../log/#fb-inconsistent-results">API may return inconsistent results</a> when you search for ads in all E.U. member states collectively in a single query, than when you search each member state individually in a separate query.</div><h5>Parameter &mdash; <span class="quote">ad_type</span></h5><div class="p">We set this parameter to the default and only supported value, <span class="quote">POLITICAL_AND_ISSUE_ADS</span>.</div><h6>Not recognized in Graph Explorer API</h6><div class="pp">This parameter is not recognized by the <a href="https://developers.facebook.com/tools/explorer">Graph API Explorer</a>, a tool used by Facebook for recording API sessions and reporting bugs. Remember to remove this parameter when reporting bugs, otherwise Facebook will not be able to reproduce your API sessions.</div><h5>Parameter &mdash; <span class="quote">search_terms</span></h5><div class="p">Empirically, we find that we could retrieve the most number of ads by using the period (<span class="quote">.</span>) as the search term &mdash; after experimenting with multilingual dictionary-based approaches, stopwords, and other types of punctuations.</div><h6>No guarantee of completeness</h6><div class="pp">Even though the period (<span class="quote">.</span>) returns more ads than other search terms, the tactic does not guarantee that you will uncover all ads in the archive. In fact, the <a href="../log/#fb-no-completeness">API provides no guarantee of completeness</a>.</div><h6>Incorrect results</h6><div class="pp">Be aware, even when you specify a search term, the <a href="../log/#fb-incorrect-results">API may not return all ads matching the search term</a>.</div><h6>Unreproducible results</h6><div class="pp">More generally, the <a href="../log/#fb-unreproducible-results">results provided by the API are unreproducible</a>. You may receive significantly different results when you repeat an identical search on the same day, or even when you conduct two identical searches within seconds of each other.</div><h5>Parameter &mdash; <span class="quote">search_page_ids</span></h5><div class="p">We do not have the necessary data to use this field.</div><h6>No available values</h6><div class="pp">Even though the Ad Library API provides the capability to search for ads using <span class="quote">page_id</span>, the API does not provide a list of available <span class="quote">page_id</span>s.</div><div class="pp">Technically, a list of <span class="quote">page_id</span>s could be scraped from the Facebook Ad Library Report. However, such actions are prohibited by Facebook's terms of services. We did not take such actions, and therefore do not have the data needed to crawl political ads in the European Union using <span class="quote">page_id</span>s.</div><div class="pp">In any case, the Facebook Ad Library Report for the European Union was not released until after May 18, when the <a href="../log/#fb-invalid-next-page-bug">API had already become non-functioning</a>.</div><h5>Parameter &mdash; <span class="quote">limit</span></h5><div class="p">We request 500 ads per page at the start of each day. However, depending on the errors and error types, we may increase, decrease, or sample the potential values of <span class="quote">limit</span>.</div><h6>Reasons for decreasing the value</h6><div class="pp">Even though in public statements (e.g., <a href="https://www.facebook.com/ads/library/api">Ad Library FAQ</a>), Facebook states that users may request up to 5,000 ads per page, empirically, we find that the <a href="../log/#fb-high-error-rates">API fails with increasing frequency</a> as we request more ads per page. While the API may succeed on odd occasions, it would frequently return zero ads and ask us to re-try our requests. On May 7, when we last <a href="../log/#20190507-errors">measured the API failure rates</a>, we received on average 223, 125, and 101 ads per page, when we requested 1,000, 2,000, and 4,000 ads respectively.</div><div class="pp">When you encounter a significant amount of general API failures, you may wish to reduce <span class="quote">limit</span> otherwise <i>requesting more ads</i> may cause the API to <i>return fewer ads</i>.</div><h6>Reasons for increasing the value</h6><div class="pp">Due to the numerous pagination bugs in the Ad Library API, we often cannot retrieve all pages associated with a search (e.g., <a href="../log/#fb-infinite-loop-bug">infinite loop bug</a>, <a href="../log/#fb-invalid-next-page-bug">invalid next page bug</a>, <a href="../log/#fb-random-termination-bug">random termination bug</a>). In which case, increasing the value of <span class="quote">limit</span> may reduce the chance of encountering a pagination failure and improve the likelihood of completing a search.</div><div class="pp">On the days when you encounter a significant amount of pagination errors, you may wish to increase the value of <span class="quote">limit</span>. Retrieving each additional page is like playing a round of Russian roulette, it's strategic to <i>minimize the number of potential failure points</i>.</div><h6>Reasons for sampling potential values</h6><div class="pp">The Ad Library API can fail in other unexpected ways. In early May, the <a href="../log/#fb-100-ads-per-page-bug">API would fail when returning exactly 100 ads per page</a>. Starting in late May, the <a href="../log/#fb-one-page-bug">API would fail when returning exactly one page of ads</a>.</div><div class="pp">You may wish to randomly perturb the value of <span class="quote">limit</span> to guard against such failures.</div></div></div><div class="section google" id="google"><h3>Google Ad Library</h3><div class="content google"><div class="p">Google releases their political ads archive as a public dataset. Below, we describe our SQL statements for retrieving advertiser and ad data.</div><h5>Advertiser Statistics</h5><div class="p">We download a list of advertisers by executing the following <a href="https://console.cloud.google.com/bigquery?sq=556480232028:82a92a5aaa0a4276b35a33c836b6bf6f">SQL query</a> on Google BigQuery.</div><div class="p"><span class="verbatim">SELECT * FROM `bigquery-public-data.google_political_ads.advertiser_stats` WHERE elections = "EU-Parliament";</span></div><h5>Ad Statistics</h5><div class="p">We download a list of ads by executing the following <a href="https://console.cloud.google.com/bigquery?sq=556480232028:7eb608ca556d42149a183582f63cda5d">SQL query</a> on Google BigQuery.</div><div class="p"><span class="verbatim">SELECT * FROM `bigquery-public-data.google_political_ads.creative_stats` WHERE regions != "US" and regions != "IN";</span></div><h6>Future updates</h6><div class="pp">During the 2019 European Parliament election, the Google Ad Library contained only ads for three election cycles in the US, India, and the European Union. The above query will need to be updated in the future.</div></div></div></body></html>